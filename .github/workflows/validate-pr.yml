name: Validate Pull Request

on:
  pull_request:
    branches: [master, main]
    paths:
      - '**.html'
      - '**.css'
      - '**.js'
      - '.github/workflows/**'

jobs:
  validate:
    name: Code Quality & Structure Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm init -y
          npm install --save-dev eslint stylelint stylelint-config-standard html-validate

      - name: Validate HTML
        run: |
          echo "üîç Validating HTML structure..."
          npx html-validate index.html --formatter stylish || echo "‚ö†Ô∏è HTML validation warnings found"
        continue-on-error: true

      - name: Lint CSS
        run: |
          echo "üé® Linting CSS..."
          npx stylelint "*.css" --config-basedir . || echo "‚ö†Ô∏è CSS linting warnings found"
        continue-on-error: true

      - name: Lint JavaScript
        run: |
          echo "üìú Linting JavaScript..."
          npx eslint "*.js" --fix-dry-run || echo "‚ö†Ô∏è JavaScript linting warnings found"
        continue-on-error: true

      - name: Check file sizes
        run: |
          echo "üìä Checking file sizes..."
          echo "=== File Sizes ==="
          ls -lh *.html *.css *.js 2>/dev/null || true

          echo ""
          echo "=== Size Limits Check ==="

          # Check if any HTML file is larger than 500KB
          if find . -maxdepth 1 -name "*.html" -size +500k | grep -q .; then
            echo "‚ö†Ô∏è Warning: HTML files larger than 500KB found"
            find . -maxdepth 1 -name "*.html" -size +500k -exec ls -lh {} \;
          else
            echo "‚úÖ HTML file sizes OK"
          fi

          # Check if any CSS file is larger than 100KB
          if find . -maxdepth 1 -name "*.css" -size +100k | grep -q .; then
            echo "‚ö†Ô∏è Warning: CSS files larger than 100KB found"
            find . -maxdepth 1 -name "*.css" -size +100k -exec ls -lh {} \;
          else
            echo "‚úÖ CSS file sizes OK"
          fi

          # Check if any JS file is larger than 50KB
          if find . -maxdepth 1 -name "*.js" -size +50k | grep -q .; then
            echo "‚ö†Ô∏è Warning: JavaScript files larger than 50KB found"
            find . -maxdepth 1 -name "*.js" -size +50k -exec ls -lh {} \;
          else
            echo "‚úÖ JavaScript file sizes OK"
          fi

      - name: Check required files
        run: |
          echo "üìã Checking required files..."

          REQUIRED_FILES=("index.html" "styles.css" "script.js")
          MISSING_FILES=()

          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              MISSING_FILES+=("$file")
              echo "‚ùå Missing required file: $file"
            else
              echo "‚úÖ Found: $file"
            fi
          done

          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo ""
            echo "‚ö†Ô∏è Missing ${#MISSING_FILES[@]} required file(s)"
            exit 1
          fi

          echo ""
          echo "‚úÖ All required files present"

      - name: Check HTML structure
        run: |
          echo "üèóÔ∏è Checking HTML structure..."

          # Check for required meta tags
          echo "Checking meta tags..."
          grep -q 'charset=' index.html && echo "‚úÖ Charset meta tag found" || echo "‚ùå Missing charset meta tag"
          grep -q 'viewport' index.html && echo "‚úÖ Viewport meta tag found" || echo "‚ùå Missing viewport meta tag"
          grep -q 'description' index.html && echo "‚úÖ Description meta tag found" || echo "‚ùå Missing description meta tag"

          # Check for external resources
          echo ""
          echo "Checking external resources..."
          grep -q 'link.*stylesheet.*styles.css' index.html && echo "‚úÖ External CSS linked correctly" || echo "‚ùå External CSS not linked"
          grep -q 'script.*src.*script.js' index.html && echo "‚úÖ External JS linked correctly" || echo "‚ùå External JS not linked"

          # Check for inline styles/scripts (should be minimal)
          echo ""
          echo "Checking for inline styles/scripts..."
          INLINE_STYLES=$(grep -c '<style>' index.html || echo "0")
          INLINE_SCRIPTS=$(grep -c '<script>.*[^src=]' index.html || echo "0")

          if [ "$INLINE_STYLES" -gt 0 ]; then
            echo "‚ö†Ô∏è Found $INLINE_STYLES inline style tag(s) - consider moving to styles.css"
          else
            echo "‚úÖ No inline styles found"
          fi

          if [ "$INLINE_SCRIPTS" -gt 1 ]; then
            echo "‚ö†Ô∏è Found $INLINE_SCRIPTS inline script tag(s) - consider moving to script.js"
          else
            echo "‚úÖ Minimal inline scripts"
          fi

      - name: Check JavaScript functionality
        run: |
          echo "üß™ Checking JavaScript syntax..."

          # Check for common JavaScript errors
          if node -c script.js 2>/dev/null; then
            echo "‚úÖ JavaScript syntax is valid"
          else
            echo "‚ùå JavaScript syntax errors found"
            node -c script.js
            exit 1
          fi

          # Check for console.log statements (should be removed in production)
          echo ""
          echo "Checking for debug statements..."
          if grep -n "console\.log\|console\.debug\|debugger" script.js; then
            echo "‚ö†Ô∏è Found debug statements - consider removing for production"
          else
            echo "‚úÖ No debug statements found"
          fi

      - name: Check CSS quality
        run: |
          echo "üé® Checking CSS quality..."

          # Check for !important overuse
          echo "Checking for !important usage..."
          IMPORTANT_COUNT=$(grep -c '!important' styles.css || echo "0")

          if [ "$IMPORTANT_COUNT" -gt 10 ]; then
            echo "‚ö†Ô∏è Found $IMPORTANT_COUNT !important declarations - consider refactoring"
            grep -n '!important' styles.css | head -10
          elif [ "$IMPORTANT_COUNT" -gt 0 ]; then
            echo "‚ÑπÔ∏è Found $IMPORTANT_COUNT !important declarations"
          else
            echo "‚úÖ No !important declarations"
          fi

          # Check for vendor prefixes (could use autoprefixer)
          echo ""
          echo "Checking for vendor prefixes..."
          PREFIXES=$(grep -c '\-webkit-\|\-moz-\|\-ms-\|\-o-' styles.css || echo "0")

          if [ "$PREFIXES" -gt 0 ]; then
            echo "‚ÑπÔ∏è Found $PREFIXES vendor prefixes - consider using autoprefixer"
          else
            echo "‚úÖ No manual vendor prefixes (or already processed)"
          fi

      - name: Security check
        run: |
          echo "üîí Running security checks..."

          # Check for inline event handlers (XSS risk)
          echo "Checking for inline event handlers..."
          if grep -E 'on(click|load|error|mouse|key)=' index.html; then
            echo "‚ö†Ô∏è Found inline event handlers - consider moving to script.js for better CSP"
          else
            echo "‚úÖ No inline event handlers found"
          fi

          # Check for external script sources
          echo ""
          echo "Checking external resources..."
          if grep -o 'src="http[^"]*"' index.html | grep -v 'fonts.googleapis.com\|fonts.gstatic.com'; then
            echo "‚ÑπÔ∏è External resources found - ensure they are from trusted sources"
          else
            echo "‚úÖ Only trusted external resources"
          fi

      - name: Generate report summary
        if: always()
        run: |
          echo ""
          echo "================================================"
          echo "üìä VALIDATION SUMMARY"
          echo "================================================"
          echo ""
          echo "Repository: ${{ github.repository }}"
          echo "PR: #${{ github.event.pull_request.number }}"
          echo "Branch: ${{ github.head_ref }}"
          echo "Commit: ${{ github.sha }}"
          echo ""
          echo "‚úÖ Validation completed!"
          echo ""
          echo "Review the checks above for any warnings or issues."
          echo "================================================"

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Get file sizes
            const getFileSize = (file) => {
              try {
                const stats = fs.statSync(file);
                return (stats.size / 1024).toFixed(2) + ' KB';
              } catch {
                return 'N/A';
              }
            };

            const htmlSize = getFileSize('index.html');
            const cssSize = getFileSize('styles.css');
            const jsSize = getFileSize('script.js');

            const comment = `## ü§ñ Automated Code Validation Report

            **PR:** #${{ github.event.pull_request.number }}
            **Branch:** \`${{ github.head_ref }}\`
            **Commit:** \`${{ github.sha }}\`

            ### üìä File Sizes
            | File | Size |
            |------|------|
            | index.html | ${htmlSize} |
            | styles.css | ${cssSize} |
            | script.js | ${jsSize} |

            ### ‚úÖ Validation Checks
            - ‚úÖ HTML structure validation
            - ‚úÖ CSS linting
            - ‚úÖ JavaScript linting
            - ‚úÖ File size checks
            - ‚úÖ Required files present
            - ‚úÖ Security checks

            ### üìù Notes
            See the [Actions tab](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed results.

            ---
            *This is an automated validation report. Review any warnings above.*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
